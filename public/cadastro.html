<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Beleza & Cia</title>
    <link rel="stylesheet" href="css/global.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="dashboard.html" class="nav-brand">Beleza & Cia</a>
            <div class="user-info">
                <span id="userEmail"></span>
                <button class="logout-btn btn-sm" id="logoutBtn">Sair</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="page-container">
                <div class="text-center mb-8">
                    <h1>Cadastrar Novo Usuário</h1>
                    <p class="text-gray-600">Apenas administradores podem cadastrar novos usuários no sistema</p>
                </div>

                <form id="cadastroForm" class="form-container" style="max-width: 500px; margin: 0 auto;">
                    <div class="form-group">
                        <label for="nome" class="form-label">Nome Completo *</label>
                        <input type="text" id="nome" class="form-control" placeholder="Nome do usuário" required>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" id="email" class="form-control" placeholder="usuario@email.com" required>
                    </div>

                    <div class="form-group">
                        <label for="senha" class="form-label">Senha *</label>
                        <input type="password" id="senha" class="form-control" placeholder="Mínimo 6 caracteres"
                            required minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="confirmarSenha" class="form-label">Confirmar Senha *</label>
                        <input type="password" id="confirmarSenha" class="form-control" placeholder="Digite novamente"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="perfil" class="form-label">Perfil de Acesso *</label>
                        <select id="perfil" class="form-control" required>
                            <option value="">Selecione um perfil</option>
                            <option value="funcionario">Funcionário</option>
                            <option value="profissional">Profissional</option>
                            <option value="admin">Administrador</option>
                        </select>
                        <p class="text-sm text-gray-500 mt-1">
                            <strong>Funcionário:</strong> Pode criar agendamentos e gerenciar clientes<br>
                            <strong>Profissional:</strong> Acesso à agenda pessoal e comissões<br>
                            <strong>Administrador:</strong> Pode tudo + gerenciar serviços e usuários
                        </p>
                    </div>

                    <div class="d-flex gap-2 mt-6">
                        <button type="submit" class="btn btn-primary flex-1">Cadastrar Usuário</button>
                        <a href="dashboard.html" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>

                <div id="cadastroError" class="alert alert-danger mt-4 d-none"></div>
                <div id="cadastroSuccess" class="alert alert-success mt-4 d-none"></div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <footer class="footer">
        <div class="container footer-content">
            <p>&copy; 2024 Beleza & Cia. Sistema de Gestão para Salões.</p>
        </div>
    </footer>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { createUserWithEmailAndPassword, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Elementos DOM
        const form = document.getElementById('cadastroForm');
        const errorDiv = document.getElementById('cadastroError');
        const successDiv = document.getElementById('cadastroSuccess');
        const userEmailElement = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');

        // Verificar autenticação e permissões
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Mostrar email do usuário
            if (userEmailElement) {
                userEmailElement.textContent = user.email;
            }

            // Configurar logout
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Erro ao fazer logout:', error);
                    }
                });
            }

            // Verificar se é administrador
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.role !== 'admin') {
                        alert('Apenas administradores podem cadastrar novos usuários!');
                        window.location.href = 'dashboard.html';
                    }
                } else {
                    alert('Perfil não encontrado!');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Erro ao verificar perfil:', error);
                window.location.href = 'index.html';
            }
        });

        // Função para criar usuário com perfil
        async function createUserWithProfile(email, password, nome, role = 'funcionario') {
            try {
                // Criar usuário no Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Atualizar nome no perfil
                await updateProfile(user, { displayName: nome });

                // Criar documento no Firestore com perfil
                await setDoc(doc(db, "users", user.uid), {
                    nome: nome,
                    email: email,
                    role: role,
                    criadoEm: new Date(),
                    ativo: true
                });

                return user;
            } catch (error) {
                console.error("Erro ao criar usuário:", error);
                throw error;
            }
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const nome = document.getElementById('nome').value.trim();
            const email = document.getElementById('email').value.trim();
            const senha = document.getElementById('senha').value;
            const confirmarSenha = document.getElementById('confirmarSenha').value;
            const perfil = document.getElementById('perfil').value;

            // Validações
            if (senha !== confirmarSenha) {
                showError('As senhas não coincidem!');
                return;
            }

            if (senha.length < 6) {
                showError('A senha deve ter no mínimo 6 caracteres!');
                return;
            }

            if (!perfil) {
                showError('Selecione um perfil de acesso!');
                return;
            }

            try {
                // Mostrar loading
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                btn.textContent = 'Cadastrando...';
                btn.disabled = true;

                // Criar usuário
                await createUserWithProfile(email, senha, nome, perfil);

                // Sucesso
                showSuccess('✅ Usuário cadastrado com sucesso!');
                form.reset();

            } catch (error) {
                let mensagem = 'Erro ao cadastrar usuário: ';

                switch (error.code) {
                    case 'auth/email-already-in-use':
                        mensagem += 'Este email já está em uso.';
                        break;
                    case 'auth/invalid-email':
                        mensagem += 'Email inválido.';
                        break;
                    case 'auth/weak-password':
                        mensagem += 'Senha muito fraca.';
                        break;
                    default:
                        mensagem += error.message;
                }

                showError(mensagem);
            } finally {
                // Restaurar botão
                const btn = form.querySelector('button[type="submit"]');
                btn.textContent = 'Cadastrar Usuário';
                btn.disabled = false;
            }
        });

        function showError(mensagem) {
            errorDiv.textContent = mensagem;
            errorDiv.classList.remove('d-none');
            successDiv.classList.add('d-none');
            scrollToElement(errorDiv);
        }

        function showSuccess(mensagem) {
            successDiv.textContent = mensagem;
            successDiv.classList.remove('d-none');
            errorDiv.classList.add('d-none');
            scrollToElement(successDiv);
        }

        function scrollToElement(element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Toast function
        function showToast(mensagem, tipo = "info") {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement("div");
            toast.className = `toast toast-${tipo}`;
            toast.innerHTML = `
                <span class="toast-icon">${tipo === 'success' ? '✅' : tipo === 'error' ? '❌' : 'ℹ️'}</span>
                <span>${mensagem}</span>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>

</html>